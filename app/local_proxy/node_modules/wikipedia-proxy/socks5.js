const socks = require("socksv5")
const https = require("https")
const http = require("http")

const random = function (min, max) {
    return Math.floor(Math.random() * (max - min + 1) + min)
}

// 创建 socks5 server
const createServer = function (ssl, listener) {
    const host = "127.0.0.1"

    const httpsPort = random(20000, 30000)
    https.createServer(ssl, listener).listen(httpsPort, host)

    const httpPort = random(20000, 30000)
    http.createServer(listener).listen(httpPort, host)

    const server = socks.createServer(function (info, accept, deny) {
        info.dstAddr = host
        if (info.dstPort == 443) {
            info.dstPort = httpsPort
        } else {
            info.dstPort = httpPort
        }
        accept()
    })

    server.useAuth(socks.auth.None())

    return server
}

module.exports = {
    createServer
}
