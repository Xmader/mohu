const https = require("https")
const httpProxy = require("http-proxy")
const fs = require("fs")

const ssl = {
    cert: fs.readFileSync(`${__dirname}/cert.crt`),
    key: fs.readFileSync(`${__dirname}/rsa.key`)
}

const proxy = httpProxy.createProxyServer({})

proxy.on("proxyReq", function (proxyReq) {
    proxyReq.setHeader("Host", "zh.wikipedia.org")
})

module.exports.run = function (port = 443, host = "localhost", silent = false) {
    const server = https.createServer(ssl, function (req, res) {
        req.headers["Host"] = "zh.wikipedia.org"
        req.headers["Accept-Encoding"] = ""
        proxy.web(req, res, {
            target: "https://en.wikipedia.org/",
            changeOrigin: true,
            hostRewrite: `${host}:${port}`,
        })
    })

    if (!silent) {
        console.log(`listening on port ${port}`)
        console.log(`Available on: https://${host}:${port}`)
        console.log("Hit CTRL-C to stop the server")
    }

    server.listen(port)
}
