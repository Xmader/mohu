const { Resolver } = require("dns")
const net = require("net")

const resolver = new Resolver()
resolver.setServers(["202.141.162.123", "202.38.93.153"])

let results = {}

/**
 * Promise化的DNS解析
 * @param {string} hostname 需要解析的主机名. 如果是一个IP地址, 则返回解析值为 `[hostname]` 的一个Promise
 * @param {boolean} cache 是否缓存DNS解析结果
 * @returns {Promise<string[]>}
 */
const resolve4 = (hostname, cache = true) => {
    if (net.isIP(hostname)) return Promise.resolve([hostname])

    return new Promise((resolve, reject) => {
        if (cache && results[hostname]) {
            resolve(results[hostname])
        } else {
            resolver.resolve4(hostname, (err, addresses) => {
                if (err) {
                    reject(err)
                } else {
                    if (cache) {
                        Object.assign(results, {
                            [hostname]: addresses
                        })
                    }
                    resolve(addresses)
                }
            })
        }
    })
}

module.exports = {
    resolve4
}
